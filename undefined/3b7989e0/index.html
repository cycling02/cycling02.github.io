<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>BaiYun</title><meta name="author" content="Li Hua"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><meta name="generator" content="Hexo 7.2.0"></head><body><header id="page_header"><div class="header_wrap"><div id="blog_name"><a class="blog_title" id="site-name" href="/">BaiYun</a></div><button class="menus_icon"><div class="navicon"></div></button><ul class="menus_items"><li class="menus_item"><a class="site-page" href="/#Publications"> Publications</a></li><li class="menus_item"><a class="site-page" href="/"> About</a></li><li class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://phower.me"> Blog</a></li></ul></div></header><main id="page_main"><div class="side-card sticky"><div class="card-wrap" itemscope itemtype="http://schema.org/Person"><div class="author-avatar"><img class="avatar-img" src="/themes/Academia/source/img/profile.jpg" onerror="this.onerror=null;this.src='/img/profile.png'" alt="avatar"></div><div class="author-discrip"><h3>Li Hua</h3><p class="author-bio">Your biography can be writed down here.</p></div><div class="author-links"><button class="btn m-social-links">Links</button><ul class="social-icons"><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-github" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-weixin" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-qq" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fas fa-envelope" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fas fa-rss" aria-hidden="true"></i></a></li></ul><ul class="social-links"><li><a class="e-social-link" href="/" target="_blank"><i class="fas fa-graduation-cap" aria-hidden="true"></i><span>Google Scholar</span></a></li><li><a class="e-social-link" href="/" target="_blank"><i class="fab fa-orcid" aria-hidden="true"></i><span>ORCID</span></a></li></ul></div><a class="cv-links" href="/attaches/CV.pdf" target="_blank"><i class="fas fa-file-pdf" aria-hidden="true"><span>My Detail CV.</span></i></a></div></div><div class="page" itemscope itemtype="http://schema.org/CreativeWork"><h2 class="page-title">基于docker搭建监控系统&日志收集</h2><article><h2 id="什么是Prometheus"><a href="#什么是Prometheus" class="headerlink" title="什么是Prometheus?"></a><strong>什么是Prometheus?</strong></h2><p>Prometheus是由SoundCloud开发的开源监控报警系统和时序列数据库(TSDB)。Prometheus使用Go语言开发，是Google BorgMon监控系统的开源版本。<br>2016年由Google发起Linux基金会旗下的原生云基金会(Cloud Native Computing Foundation), 将Prometheus纳入其下第二大开源项目。<br>Prometheus目前在开源社区相当活跃。<br>Prometheus和Heapster(Heapster是K8S的一个子项目，用于获取集群的性能数据。)相比功能更完善、更全面。Prometheus性能也足够支撑上万台规模的集群。</p>
<p><strong>Prometheus的特点</strong></p>
<ul>
<li>多维度数据模型。</li>
<li>灵活的查询语言。</li>
<li>不依赖分布式存储，单个服务器节点是自主的。</li>
<li>通过基于HTTP的pull方式采集时序数据。</li>
<li>可以通过中间网关进行时序列数据推送。</li>
<li>通过服务发现或者静态配置来发现目标服务对象。</li>
<li>支持多种多样的图表和界面展示，比如Grafana等。<br><strong>监控系统架构图</strong></li>
</ul>
<p><img src="https://pic2.zhimg.com/80/v2-c4fda4a89b8a7d3006a5bd522bab04f9_720w.webp"></p>
<h2 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a><strong>拉取镜像</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull prom/node-exporter</span><br><span class="line">docker pull prom/prometheus</span><br><span class="line">docker pull grafana/grafana       </span><br></pre></td></tr></table></figure>

<p><strong>启动node-exporter</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9100:9100 \</span><br><span class="line">  -v &quot;/proc:/host/proc:ro&quot; \</span><br><span class="line">  -v &quot;/sys:/host/sys:ro&quot; \</span><br><span class="line">  -v &quot;/:/rootfs:ro&quot; \</span><br><span class="line">  --net=&quot;host&quot; \</span><br><span class="line">  prom/node-exporter</span><br></pre></td></tr></table></figure>

<p>访问<a href="https://link.zhihu.com/?target=http://ip:9100/metrics">http://ip:9100/metrics</a><br><strong>启动prometheus</strong></p>
<p>新建目录prometheus，编辑配置文件prometheus.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/prometheus</span><br><span class="line">cd /opt/prometheus/</span><br><span class="line">vi prometheus.yml</span><br></pre></td></tr></table></figure>




<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     60s</span><br><span class="line">  evaluation_interval: 60s</span><br><span class="line"> </span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: prometheus</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;96.8.121.168:9090&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: prometheus</span><br><span class="line"> </span><br><span class="line">  - job_name: linux</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;96.8.121.168:9100&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: 96.8.121.168</span><br></pre></td></tr></table></figure>

<p>注意：修改IP地址，这里的ip就是本机地址</p>
<p><strong>启动prometheus</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run  -d \</span><br><span class="line">  -p 10050:9090 \</span><br><span class="line">  -v /opt/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml  \</span><br><span class="line">  prom/prometheus</span><br></pre></td></tr></table></figure>




<p>等待几秒查询端口状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -anpt</span><br></pre></td></tr></table></figure>

<p>访问url</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:10050/graph</span><br></pre></td></tr></table></figure>

<p><img src="https://pic3.zhimg.com/80/v2-10470180ee63b26709a88bf86500cb5a_720w.webp"></p>
<p>访问targets，url如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:10050/targets               </span><br></pre></td></tr></table></figure>

<p><img src="https://pic4.zhimg.com/80/v2-6e9b8fe9a29b46f3fb6fed1c756ca817_720w.webp"></p>
<p><strong>启动grafana</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-p 10051:3000 \</span><br><span class="line">--name=grafana \</span><br><span class="line">-e &quot;GF_SERVER_ROOT_URL=http://grafana.server.name&quot; \</span><br><span class="line">-e &quot;GF_SECURITY_ADMIN_PASSWORD=admin&quot; \</span><br><span class="line">grafana/grafana</span><br></pre></td></tr></table></figure>

<p>访问首页</p>
<p><a href="https://link.zhihu.com/?target=http://ip:10051/">http://ip:10051</a> admin admin</p>
<p><img src="https://pic1.zhimg.com/80/v2-c2b7545a4acc4b583bca9fd3fca1d670_720w.webp"></p>
<p>添加数据源</p>
<p><img src="https://pic2.zhimg.com/80/v2-63aa46998d5176c434d3a443f1f3fad9_720w.webp"></p>
<p><img src="https://pic3.zhimg.com/80/v2-1f124d2de0b7cf434cd8b51f3f4ed46e_720w.webp"></p>
<p><strong>监测服务器负载配置</strong></p>
<p>create-&gt;import填入8919模板引擎，选择prometheus数据源，就能加载出服务器负载到主页</p>
<p><img src="https://pic1.zhimg.com/80/v2-8967bb5016ade21638fe604715482c5c_720w.webp"></p>
<p>监控主页</p>
<p><img src="https://pic2.zhimg.com/80/v2-56858eb5242d9310236663e1396c34e9_720w.webp"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     60s</span><br><span class="line">  evaluation_interval: 60s</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line"></span><br><span class="line">  - job_name: prometheus</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: prometheus</span><br><span class="line"></span><br><span class="line">  - job_name: linux</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;96.8.121.168:9100&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: localhost</span><br><span class="line">   #  - targets: [&#x27;ip:9100&#x27;]  </span><br><span class="line">   #这里添加targets，可以使用Prometheus监控其他装有node_exporter的节点，单节点则不需要</span><br><span class="line">   #    labels:</span><br><span class="line">   #      instance: 192.168.1.22</span><br><span class="line"></span><br><span class="line">  - job_name: cadvisor</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;172.17.0.6:8080&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: cAdvisor</span><br><span class="line"></span><br><span class="line">  - job_name: mysqld</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;96.8.121.168:9104&#x27;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: mysql-exporter</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意：修改IP地址，这里的172.17.0. xx就是docker容器内的私网，需要自行查询:<code>:</code></p>
</article></div></main><div class="nav-wrap"><div class="nav"><button class="site-nav"><div class="navicon"></div></button><ul class="nav_items"><li class="nav_item"><a class="nav-page" href="/#Publications"> Publications</a></li><li class="nav_item"><a class="nav-page" href="/"> About</a></li><li class="nav_item"><a class="nav-page" target="_blank" rel="noopener" href="https://phower.me"> Blog</a></li></ul></div><div class="cd-top"><i class="fa fa-arrow-up" aria-hidden="true"></i></div></div><footer id="page_footer"><div class="footer_wrap"><div class="copyright">&copy;2023 - 2024 by Li Hua</div><div class="theme-info">Powered by <a target="_blank" href="https://hexo.io" rel="nofollow noopener">Hexo</a> & <a target="_blank" href="https://github.com/PhosphorW/hexo-theme-academia" rel="nofollow noopener">Academia Theme</a></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery-pjax@latest/jquery.pjax.min.js"></script><script src="/js/main.js"></script></body></html>